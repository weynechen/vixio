# Per-Session Transport æ¶æ„è®¾è®¡

> **çŠ¶æ€**: ğŸ“ è®¾è®¡ä¸­
> **ç›®æ ‡**: æ¶ˆé™¤ session_id åœ¨å†…éƒ¨ç»„ä»¶ä¸­çš„ä¼ é€’ï¼Œé€šè¿‡åˆ†å±‚è®¾è®¡ä½¿ä¼šè¯èµ„æºå®Œå…¨éš”ç¦»

## 1. é—®é¢˜åˆ†æ

### 1.1 ç°çŠ¶

å½“å‰æ¶æ„ä¸­ï¼Œ`session_id` ä½œä¸º"é’¥åŒ™"è´¯ç©¿æ•´ä¸ªç³»ç»Ÿï¼š

**TransportBase ä¸­çš„å­—å…¸**:
- `_read_queues: Dict[str, Queue]`
- `_send_queues: Dict[str, Queue]`
- `_priority_queues: Dict[str, Queue]`
- `_video_queues: Dict[str, Queue]`
- `_read_workers: Dict[str, Task]`
- `_send_workers: Dict[str, Task]`
- `_output_controllers: Dict[str, Any]`
- `_control_buses: Dict[str, ControlBus]`
- `_first_audio_sent_recorded: Dict[str, set]`

**SessionManager ä¸­çš„å­—å…¸**:
- `_sessions: Dict[str, Task]`
- `_control_buses: Dict[str, ControlBus]`
- `_dags: Dict[str, CompiledDAG]`
- `_input_stations: Dict[str, Station]`
- `_interrupt_tasks: Dict[str, Task]`

**XiaozhiTransport é¢å¤–å­—å…¸**:
- `_connections: Dict[str, WebSocket]`
- `_opus_codecs: Dict[str, OpusCodec]`
- `_device_tool_clients: Dict[str, DeviceToolClient]`
- `_session_device_map: Dict[str, str]`

### 1.2 ç—›ç‚¹

1. **å‚æ•°æ±¡æŸ“**ï¼šå‡ ä¹æ‰€æœ‰æ–¹æ³•éƒ½éœ€è¦ä¼ é€’ `session_id` å‚æ•°
2. **æŸ¥æ‰¾å¼€é”€**ï¼šæ¯æ¬¡æ“ä½œéƒ½éœ€è¦ä»å­—å…¸æŸ¥æ‰¾èµ„æº
3. **æ¸…ç†å¤æ‚**ï¼šæ–­å¼€è¿æ¥æ—¶éœ€è¦ä» 20+ ä¸ªå­—å…¸ä¸­åˆ é™¤
4. **å®¹æ˜“é—æ¼**ï¼šæ–°å¢åŠŸèƒ½æ—¶å®¹æ˜“å¿˜è®°æ·»åŠ æ¸…ç†é€»è¾‘
5. **æµ‹è¯•å›°éš¾**ï¼šéœ€è¦æ„é€ å®Œæ•´çš„ session_id æ˜ å°„å…³ç³»

### 1.3 ç›®æ ‡

**è®©å†…éƒ¨ç»„ä»¶å®Œå…¨ä¸æ„ŸçŸ¥ `session_id`**ï¼š
- ç»„ä»¶é€šè¿‡ç›´æ¥å¼•ç”¨è®¿é—®èµ„æºï¼Œè€Œä¸æ˜¯é€šè¿‡ session_id æŸ¥æ‰¾
- èµ„æºçš„ç”Ÿå‘½å‘¨æœŸä¸è¿æ¥ç»‘å®šï¼Œè‡ªåŠ¨åˆ›å»ºå’Œé”€æ¯
- ç®€åŒ–ä»£ç ï¼Œæå‡å¯ç»´æŠ¤æ€§

### 1.4 è®¾è®¡çº¦æŸ

**Transport æ˜¯å¼€æ”¾ç»™ç¬¬ä¸‰æ–¹å®ç°çš„**ï¼Œéœ€è¦æ”¯æŒå¤šç§åº•å±‚åè®®ï¼š
- WebSocketï¼ˆå¦‚ Xiaozhiï¼‰
- WebRTCï¼ˆå¦‚ LiveKitï¼‰
- UDPï¼ˆå¦‚è‡ªå®šä¹‰åè®®ï¼‰
- å…¶ä»–ä»»æ„ä¼ è¾“å±‚

å› æ­¤ï¼Œè®¾è®¡å¿…é¡»ï¼š
- **æŠ½è±¡è¿æ¥ç±»å‹**ï¼šä¸ç»‘å®šåˆ°å…·ä½“çš„ WebSocket/RTC/UDP
- **æ¸…æ™°çš„æ‰©å±•è¾¹ç•Œ**ï¼šç¬¬ä¸‰æ–¹åªéœ€å®ç°å¿…è¦æ¥å£
- **æ¡†æ¶æä¾›å…¬å…±èƒ½åŠ›**ï¼šworkersã€turn ç®¡ç†ã€latency è·Ÿè¸ªç­‰

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ ¸å¿ƒæ€æƒ³ï¼šä¸‰å±‚åˆ†ç¦»

å°†ç°æœ‰çš„ Transport æ‹†åˆ†ä¸ºä¸‰å±‚ï¼š

| å±‚çº§ | èŒè´£ | å®ç°æ–¹ | ç”Ÿå‘½å‘¨æœŸ |
|------|------|--------|---------|
| **TransportServerBase** | æœåŠ¡å™¨ç®¡ç†ï¼ˆç›‘å¬ã€è·¯ç”±ï¼‰ | åè®®æ–¹å®ç° | åº”ç”¨çº§ |
| **SessionTransportBase** | ä¼šè¯èµ„æºç®¡ç† + å…¬å…±èƒ½åŠ› | æ¡†æ¶æä¾› | è¿æ¥çº§ |
| **å…·ä½“ SessionTransport** | åè®®ç‰¹å®šçš„è¯»å†™å®ç° | åè®®æ–¹å®ç° | è¿æ¥çº§ |

### 2.2 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨å±‚ (Application)                          â”‚
â”‚                                                                      â”‚
â”‚   SessionManager                                                     â”‚
â”‚   â”œâ”€â”€ æŒæœ‰ TransportServerï¼ˆé•¿ç”Ÿå‘½å‘¨æœŸï¼‰                             â”‚
â”‚   â””â”€â”€ ä¸ºæ¯ä¸ªè¿æ¥: handle_session(session_transport)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               TransportServerBase (æœåŠ¡å™¨å±‚ - æŠ½è±¡)                  â”‚
â”‚               ç”Ÿå‘½å‘¨æœŸï¼šåº”ç”¨çº§                                        â”‚
â”‚                                                                      â”‚
â”‚   æ¡†æ¶å®šä¹‰æ¥å£ï¼š                                                     â”‚
â”‚   â”œâ”€â”€ start() / stop()                                               â”‚
â”‚   â”œâ”€â”€ on_new_connection(handler)                                     â”‚
â”‚   â”œâ”€â”€ on_disconnect(handler)                                         â”‚
â”‚   â””â”€â”€ get_protocol() -> ProtocolBase                                 â”‚
â”‚                                                                      â”‚
â”‚   åè®®æ–¹å®ç°ï¼ˆç¤ºä¾‹ï¼‰ï¼š                                                â”‚
â”‚   â”œâ”€â”€ XiaozhiTransportServer   (WebSocket + FastAPI)                â”‚
â”‚   â”œâ”€â”€ LiveKitTransportServer   (WebRTC + LiveKit SDK)               â”‚
â”‚   â””â”€â”€ UDPTransportServer       (UDP Socket)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                       create_session(connection) 
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SessionTransportBase (ä¼šè¯å±‚ - æ¡†æ¶æä¾›)                â”‚
â”‚              ç”Ÿå‘½å‘¨æœŸï¼šè¿æ¥çº§                                         â”‚
â”‚                                                                      â”‚
â”‚   æ¡†æ¶æä¾›çš„å…¬å…±èƒ½åŠ›ï¼š                                                â”‚
â”‚   â”œâ”€â”€ é˜Ÿåˆ—ç®¡ç†: read_queue, send_queue, priority_queue, video_queue â”‚
â”‚   â”œâ”€â”€ Worker ç®¡ç†: read_worker, send_worker (æ¡†æ¶å®ç°)              â”‚
â”‚   â”œâ”€â”€ Turn ç®¡ç†: æ£€æµ‹ TTS_STOP â†’ increment_turn                     â”‚
â”‚   â”œâ”€â”€ Latency è·Ÿè¸ª: first_audio_sent è®°å½•                           â”‚
â”‚   â”œâ”€â”€ è¾“å‡ºæ§åˆ¶: FlowController / PlayoutTracker (äºŒé€‰ä¸€)            â”‚
â”‚   â””â”€â”€ ç”Ÿå‘½å‘¨æœŸ: async with è‡ªåŠ¨æ¸…ç†                                  â”‚
â”‚                                                                      â”‚
â”‚   æ¡†æ¶å®šä¹‰çš„æŠ½è±¡æ–¹æ³•ï¼ˆåè®®æ–¹å¿…é¡»å®ç°ï¼‰ï¼š                              â”‚
â”‚   â”œâ”€â”€ _do_read() -> bytes | str | None                              â”‚
â”‚   â”œâ”€â”€ _do_write(data: bytes | str)                                  â”‚
â”‚   â””â”€â”€ _create_audio_codec() -> AudioCodec | None                    â”‚
â”‚                                                                      â”‚
â”‚   æ¡†æ¶å®šä¹‰çš„å¯é€‰æ–¹æ³•ï¼ˆåè®®æ–¹å¯è¦†ç›–ï¼‰ï¼š                                â”‚
â”‚   â”œâ”€â”€ _create_output_controller() -> FlowController | PlayoutTrackerâ”‚
â”‚   â”œâ”€â”€ _on_session_start()                                           â”‚
â”‚   â””â”€â”€ _on_session_end()                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ ç»§æ‰¿
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å…·ä½“ SessionTransport (åè®®æ–¹å®ç°)                      â”‚
â”‚                                                                      â”‚
â”‚   XiaozhiSessionTransport:                                          â”‚
â”‚   â”œâ”€â”€ _do_read(): websocket.receive()                               â”‚
â”‚   â”œâ”€â”€ _do_write(): websocket.send_bytes/text()                      â”‚
â”‚   â”œâ”€â”€ _create_audio_codec(): OpusCodec                              â”‚
â”‚   â”œâ”€â”€ _create_output_controller(): AudioFlowController              â”‚
â”‚   â””â”€â”€ åè®®ç‰¹å®š: device_tool_client, device_id                       â”‚
â”‚                                                                      â”‚
â”‚   LiveKitSessionTransport:                                          â”‚
â”‚   â”œâ”€â”€ _do_read(): audio_stream.__anext__()                          â”‚
â”‚   â”œâ”€â”€ _do_write(): audio_source.capture_frame()                     â”‚
â”‚   â”œâ”€â”€ _create_audio_codec(): None (WebRTC å†…éƒ¨å¤„ç†)                 â”‚
â”‚   â””â”€â”€ _create_output_controller(): LiveKitPlayoutTracker            â”‚
â”‚                                                                      â”‚
â”‚   UDPSessionTransport:                                              â”‚
â”‚   â”œâ”€â”€ _do_read(): socket.recvfrom()                                 â”‚
â”‚   â”œâ”€â”€ _do_write(): socket.sendto()                                  â”‚
â”‚   â””â”€â”€ ...                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DAG / Stations                               â”‚
â”‚                                                                      â”‚
â”‚   é€šè¿‡ session: SessionTransportBase è®¿é—®èµ„æº                        â”‚
â”‚   â”œâ”€â”€ session.read_queue                                             â”‚
â”‚   â”œâ”€â”€ session.send_queue                                             â”‚
â”‚   â”œâ”€â”€ session.control_bus                                            â”‚
â”‚   â”œâ”€â”€ session.protocol                                               â”‚
â”‚   â””â”€â”€ session.session_id (ä»…ç”¨äºæ—¥å¿—)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ¡†æ¶ vs åè®®æ–¹èŒè´£è¾¹ç•Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¡†æ¶æä¾› (ä¸å¯è¦†ç›–)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ é˜Ÿåˆ—åˆ›å»ºå’Œç®¡ç† (read/send/priority/video)                       â”‚
â”‚  â€¢ read_worker å¾ªç¯: è°ƒç”¨ _do_read() â†’ æ”¾å…¥ read_queue            â”‚
â”‚  â€¢ send_worker å¾ªç¯: ä» send_queue å– â†’ è¾“å‡ºæ§åˆ¶ â†’ _do_write()    â”‚
â”‚  â€¢ Turn ç®¡ç†: TTS_STOP æ£€æµ‹ â†’ control_bus.increment_turn()        â”‚
â”‚  â€¢ Latency è·Ÿè¸ª: first_audio_sent è®°å½•                            â”‚
â”‚  â€¢ ç”Ÿå‘½å‘¨æœŸç®¡ç†: async with, cleanup()                             â”‚
â”‚  â€¢ InputStation / OutputStation åˆ›å»º                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ è°ƒç”¨
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åè®®æ–¹å¿…é¡»å®ç° (æŠ½è±¡æ–¹æ³•)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ _do_read() -> bytes | str | None                                â”‚
â”‚      ä»åº•å±‚è¿æ¥è¯»å–ä¸€æ¡æ¶ˆæ¯ï¼Œè¿æ¥å…³é—­è¿”å› None                      â”‚
â”‚                                                                     â”‚
â”‚  â€¢ _do_write(data: bytes | str)                                    â”‚
â”‚      å‘åº•å±‚è¿æ¥å†™å…¥ä¸€æ¡æ¶ˆæ¯                                         â”‚
â”‚                                                                     â”‚
â”‚  â€¢ _create_audio_codec() -> AudioCodec | None                      â”‚
â”‚      åˆ›å»ºéŸ³é¢‘ç¼–è§£ç å™¨ï¼Œä¸éœ€è¦åˆ™è¿”å› None                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ å¯é€‰
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åè®®æ–¹å¯é€‰å®ç° (å¯è¦†ç›–)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ _create_output_controller() -> FlowController | PlayoutTracker  â”‚
â”‚      é€‰æ‹©è¾“å‡ºæ§åˆ¶ç­–ç•¥ï¼Œé»˜è®¤ None                                    â”‚
â”‚                                                                     â”‚
â”‚  â€¢ _on_session_start()                                             â”‚
â”‚      ä¼šè¯å¼€å§‹é’©å­ï¼Œåˆå§‹åŒ–åè®®ç‰¹å®šèµ„æº                               â”‚
â”‚                                                                     â”‚
â”‚  â€¢ _on_session_end()                                               â”‚
â”‚      ä¼šè¯ç»“æŸé’©å­ï¼Œæ¸…ç†åè®®ç‰¹å®šèµ„æº                                 â”‚
â”‚                                                                     â”‚
â”‚  â€¢ _is_tts_stop_message(data) -> bool                              â”‚
â”‚      è‡ªå®šä¹‰ TTS_STOP æ£€æµ‹é€»è¾‘                                       â”‚
â”‚                                                                     â”‚
â”‚  â€¢ _on_message_received(data) -> bool                              â”‚
â”‚      æ¶ˆæ¯é¢„å¤„ç†é’©å­ï¼Œè¿”å› True è¡¨ç¤ºå·²å¤„ç†ï¼ˆè·³è¿‡ DAGï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 å¯¹è±¡å…³ç³»å›¾

```
Before (ç°çŠ¶):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    TransportBase                          SessionManager
    â”œâ”€â”€ _read_queues["sess-1"]  â—„â”€â”€â”€â”€â”€â”€â”€â”€â–º _control_buses["sess-1"]
    â”œâ”€â”€ _read_queues["sess-2"]             _control_buses["sess-2"]
    â”œâ”€â”€ _send_queues["sess-1"]             _dags["sess-1"]
    â”œâ”€â”€ _send_queues["sess-2"]             _dags["sess-2"]
    â”œâ”€â”€ _control_buses["sess-1"]           ...
    â””â”€â”€ ...                     

    é—®é¢˜ï¼šèµ„æºåˆ†æ•£åœ¨å¤šä¸ªå­—å…¸ä¸­ï¼Œé€šè¿‡ session_id å…³è”


After (ç›®æ ‡):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    TransportServer                    SessionManager
    â””â”€â”€ (æ—  session èµ„æº)              â””â”€â”€ (æ—  session èµ„æº)

              â”‚                                â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            XiaozhiSessionTransport-1             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚  session_id = "sess-1"                  â”‚    â”‚
    â”‚  â”‚  connection = WebSocket-1               â”‚    â”‚
    â”‚  â”‚  read_queue = Queue()      â—„â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
    â”‚  â”‚  send_queue = Queue()             â”‚     â”‚    â”‚
    â”‚  â”‚  control_bus = ControlBus() â—„â”€â”€â”€â”€â”€â”¤     â”‚    â”‚
    â”‚  â”‚  dag = CompiledDAG() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
    â”‚  â”‚  ...                                    â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚  æ‰€æœ‰èµ„æºåœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œç”Ÿå‘½å‘¨æœŸä¸è¿æ¥ç»‘å®š        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            LiveKitSessionTransport-2             â”‚
    â”‚  â””â”€â”€ (åŒæ ·ç»“æ„ï¼Œä¸åŒåè®®å®ç°)                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ä¼˜åŠ¿ï¼šæ¯ä¸ª session çš„èµ„æºå®Œå…¨éš”ç¦»ï¼Œæ— éœ€å­—å…¸æŸ¥æ‰¾
```

---

## 3. ç»„ä»¶è®¾è®¡

### 3.1 TransportServerBaseï¼ˆæŠ½è±¡åŸºç±»ï¼‰

**èŒè´£**ï¼šæœåŠ¡å™¨çº§åˆ«çš„ç®¡ç†ï¼Œåè®®æ–¹å®ç°

| æŠ½è±¡æ–¹æ³• | è¯´æ˜ | å®ç°ç¤ºä¾‹ |
|---------|------|---------|
| `start()` | å¯åŠ¨æœåŠ¡å™¨ | å¯åŠ¨ FastAPI / åŠ å…¥ LiveKit Room |
| `stop()` | åœæ­¢æœåŠ¡å™¨ | å…³é—­æ‰€æœ‰è¿æ¥ï¼Œåœæ­¢ç›‘å¬ |
| `create_session(connection)` | åˆ›å»º SessionTransport | è¿”å›åè®®ç‰¹å®šçš„ Session å®ä¾‹ |

| æ¡†æ¶æ–¹æ³• | è¯´æ˜ |
|---------|------|
| `on_new_connection(handler)` | æ³¨å†Œæ–°è¿æ¥å›è°ƒ |
| `on_disconnect(handler)` | æ³¨å†Œæ–­å¼€å›è°ƒ |
| `get_protocol()` | è¿”å› Protocol å®ä¾‹ |

**æŒæœ‰çš„èµ„æº**ï¼ˆé•¿ç”Ÿå‘½å‘¨æœŸï¼‰ï¼š
- æœåŠ¡å™¨å®ä¾‹ï¼ˆFastAPI / LiveKit Room / UDP Socketï¼‰
- Protocol å®ä¾‹ï¼ˆæ— çŠ¶æ€ï¼Œå¯å…±äº«ï¼‰
- é…ç½®ä¿¡æ¯

**ä¸æŒæœ‰**ï¼š
- âŒ ä»»ä½•æŒ‰ session_id ç´¢å¼•çš„å­—å…¸

### 3.2 SessionTransportBaseï¼ˆæ¡†æ¶åŸºç±»ï¼‰

**èŒè´£**ï¼šå•ä¸ªä¼šè¯çš„å…¬å…±èƒ½åŠ›ï¼Œæ¡†æ¶æä¾›

| æ¡†æ¶æä¾›çš„å±æ€§ | ç±»å‹ | è¯´æ˜ |
|--------------|------|------|
| `session_id` | str | ä¼šè¯å”¯ä¸€æ ‡è¯†ï¼ˆæ—¥å¿—ç”¨ï¼‰ |
| `read_queue` | Queue | è¾“å…¥é˜Ÿåˆ— |
| `send_queue` | Queue | è¾“å‡ºé˜Ÿåˆ— |
| `priority_queue` | Queue | ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆæ§åˆ¶æ¶ˆæ¯ï¼‰ |
| `video_queue` | Queue | è§†é¢‘é˜Ÿåˆ— |
| `control_bus` | ControlBus | æ§åˆ¶æ€»çº¿ |
| `protocol` | ProtocolBase | åè®®å¤„ç†å™¨ï¼ˆæ¥è‡ª Serverï¼‰ |
| `output_controller` | Any | è¾“å‡ºæ§åˆ¶å™¨ |
| `audio_codec` | Any | éŸ³é¢‘ç¼–è§£ç å™¨ |

| æ¡†æ¶å®ç°çš„æ–¹æ³• | è¯´æ˜ |
|--------------|------|
| `start_workers()` | å¯åŠ¨ read/send workers |
| `stop_workers()` | åœæ­¢ workers |
| `cleanup()` | æ¸…ç†æ‰€æœ‰èµ„æº |
| `create_input_station()` | åˆ›å»º InputStation |
| `create_output_station()` | åˆ›å»º OutputStation |
| `__aenter__` / `__aexit__` | ç”Ÿå‘½å‘¨æœŸç®¡ç† |

| åè®®æ–¹å¿…é¡»å®ç° | è¯´æ˜ |
|---------------|------|
| `_do_read()` | ä»åº•å±‚è¿æ¥è¯»å– |
| `_do_write(data)` | å‘åº•å±‚è¿æ¥å†™å…¥ |
| `_create_audio_codec()` | åˆ›å»ºéŸ³é¢‘ç¼–è§£ç å™¨ |

| åè®®æ–¹å¯é€‰å®ç° | è¯´æ˜ |
|---------------|------|
| `_create_output_controller()` | åˆ›å»ºè¾“å‡ºæ§åˆ¶å™¨ |
| `_on_session_start()` | ä¼šè¯å¼€å§‹é’©å­ |
| `_on_session_end()` | ä¼šè¯ç»“æŸé’©å­ |

### 3.3 åè®®ç‰¹å®šæ‰©å±•

åè®®æ–¹å¯ä»¥åœ¨å­ç±»ä¸­æ·»åŠ åè®®ç‰¹å®šçš„å±æ€§å’Œæ–¹æ³•ï¼š

| åè®® | æ‰©å±•å±æ€§ | æ‰©å±•æ–¹æ³• |
|------|---------|---------|
| Xiaozhi | `device_id`, `device_tool_client` | `init_device_tools()` |
| LiveKit | `audio_source`, `audio_stream` | - |
| UDP | `remote_addr` | - |

### 3.4 SessionManager ç®€åŒ–

é‡æ„åï¼ŒSessionManager å˜å¾—éå¸¸ç®€å•ï¼š

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `start()` | å¯åŠ¨ TransportServer |
| `stop()` | åœæ­¢ TransportServer |
| `handle_session(session)` | ä¸º SessionTransport åˆ›å»ºå¹¶è¿è¡Œ DAG |

**ä¸å†æŒæœ‰**ï¼š
- âŒ `_sessions` å­—å…¸
- âŒ `_control_buses` å­—å…¸
- âŒ `_dags` å­—å…¸
- âŒ `_input_stations` å­—å…¸
- âŒ `_interrupt_tasks` å­—å…¸

---

## 4. æ•°æ®æµ

### 4.1 è¿æ¥å»ºç«‹æµç¨‹

```
1. Client å‘èµ·è¿æ¥ï¼ˆWebSocket / RTC / UDPï¼‰
   â”‚
2. TransportServer æ¥æ”¶è¿æ¥
   â”‚
3. TransportServer.create_session(connection)
   â”‚
   â”œâ”€â”€ ç”Ÿæˆ session_id
   â”œâ”€â”€ åˆ›å»ºå…·ä½“ SessionTransport å®ä¾‹
   â”‚   â”œâ”€â”€ æ¡†æ¶åˆå§‹åŒ–ï¼šé˜Ÿåˆ—ã€control_bus
   â”‚   â””â”€â”€ åè®®åˆå§‹åŒ–ï¼š_create_audio_codec(), _create_output_controller()
   â””â”€â”€ è¿”å› SessionTransport
   â”‚
4. SessionManager.handle_session(session_transport)
   â”‚
   â”œâ”€â”€ async with session_transport:
   â”‚   â”œâ”€â”€ session.start_workers()
   â”‚   â”œâ”€â”€ åˆ›å»º DAGï¼ˆä½¿ç”¨ session çš„èµ„æºï¼‰
   â”‚   â””â”€â”€ è¿è¡Œ DAG
   â””â”€â”€ é€€å‡ºæ—¶è‡ªåŠ¨ cleanup
   â”‚
5. æ­£å¸¸è¿è¡Œï¼Œå¤„ç†éŸ³é¢‘æµ
```

### 4.2 è¿æ¥æ–­å¼€æµç¨‹

```
1. Client æ–­å¼€ / ç½‘ç»œå¼‚å¸¸ / è¶…æ—¶
   â”‚
2. async with å—é€€å‡º
   â”‚
3. SessionTransport.cleanup() è‡ªåŠ¨è°ƒç”¨
   â”‚
   â”œâ”€â”€ æ¡†æ¶æ¸…ç†ï¼š
   â”‚   â”œâ”€â”€ åœæ­¢ read_worker, send_worker
   â”‚   â”œâ”€â”€ æ¸…ç©ºé˜Ÿåˆ—
   â”‚   â””â”€â”€ é‡Šæ”¾ control_bus
   â”‚
   â””â”€â”€ åè®®æ¸…ç†ï¼ˆ_on_session_endï¼‰ï¼š
       â”œâ”€â”€ é‡Šæ”¾ audio_codec
       â””â”€â”€ é‡Šæ”¾åè®®ç‰¹å®šèµ„æº
   â”‚
4. SessionTransport å¯¹è±¡è¢«é”€æ¯
   â”‚
5. Python GC å›æ”¶æ‰€æœ‰èµ„æº
```

### 4.3 å†…éƒ¨ç»„ä»¶è®¿é—®èµ„æº

```
Before:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def send_audio(self, session_id: str, data: bytes):
    queue = self.transport._send_queues[session_id]  # å­—å…¸æŸ¥æ‰¾
    await queue.put(data)


After:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def send_audio(self, data: bytes):
    await self.session.send_queue.put(data)  # ç›´æ¥å¼•ç”¨
```

---

## 5. æ¥å£å˜åŒ–

### 5.1 Station æ¥å£å˜åŒ–

**Before**: Station æ„é€ æ—¶æ¥æ”¶å¤šä¸ªç‹¬ç«‹å‚æ•°

**After**: Station æ„é€ æ—¶æ¥æ”¶ `SessionTransportBase` å¼•ç”¨ï¼Œé€šè¿‡å®ƒè®¿é—®æ‰€æœ‰èµ„æº

| è®¿é—®æ–¹å¼ | Before | After |
|---------|--------|-------|
| é˜Ÿåˆ— | `self.read_queue` (æ„é€ æ—¶ä¼ å…¥) | `self.session.read_queue` |
| åè®® | `self.protocol` (æ„é€ æ—¶ä¼ å…¥) | `self.session.protocol` |
| ç¼–è§£ç å™¨ | `self.audio_codec` (æ„é€ æ—¶ä¼ å…¥) | `self.session.audio_codec` |
| ä¼šè¯ID | `self.session_id` (æ„é€ æ—¶ä¼ å…¥) | `self.session.session_id` |
| æ§åˆ¶æ€»çº¿ | `self.control_bus` (æ„é€ æ—¶ä¼ å…¥) | `self.session.control_bus` |

### 5.2 æ–¹æ³•ç­¾åå˜åŒ–

| ç»„ä»¶ | Before | After |
|------|--------|-------|
| è¯»å–æ•°æ® | `_do_read(session_id)` | `_do_read()` |
| å†™å…¥æ•°æ® | `_do_write(session_id, data)` | `_do_write(data)` |
| è·å–é˜Ÿåˆ— | `get_read_queue(session_id)` | `session.read_queue` |
| Station æ„é€  | `__init__(session_id, queue, ...)` | `__init__(session)` |

### 5.3 ç¬¬ä¸‰æ–¹å®ç°æŒ‡å—

å®ç°æ–°åè®®åªéœ€ä¸¤æ­¥ï¼š

**Step 1**: å®ç° `TransportServerBase`

| å¿…é¡»å®ç° | è¯´æ˜ |
|---------|------|
| `start()` | å¯åŠ¨æœåŠ¡å™¨/åŠ å…¥æˆ¿é—´ |
| `stop()` | åœæ­¢æœåŠ¡å™¨/ç¦»å¼€æˆ¿é—´ |
| `create_session(conn)` | åˆ›å»ºåè®®ç‰¹å®šçš„ SessionTransport |
| `_create_protocol()` | åˆ›å»º Protocol å®ä¾‹ |

**Step 2**: å®ç° `SessionTransportBase` å­ç±»

| å¿…é¡»å®ç° | è¯´æ˜ |
|---------|------|
| `_do_read()` | ä»åº•å±‚è¿æ¥è¯»å–ä¸€æ¡æ¶ˆæ¯ |
| `_do_write(data)` | å‘åº•å±‚è¿æ¥å†™å…¥ä¸€æ¡æ¶ˆæ¯ |
| `_create_audio_codec()` | åˆ›å»ºéŸ³é¢‘ç¼–è§£ç å™¨ï¼ˆæˆ–è¿”å› Noneï¼‰ |

| å¯é€‰å®ç° | è¯´æ˜ |
|---------|------|
| `_create_output_controller()` | é€‰æ‹©è¾“å‡ºæ§åˆ¶ç­–ç•¥ |
| `_on_session_start()` | åˆå§‹åŒ–åè®®ç‰¹å®šèµ„æº |
| `_on_session_end()` | æ¸…ç†åè®®ç‰¹å®šèµ„æº |

---

## 6. å¤šåè®®é€‚é…éªŒè¯

### 6.1 åè®®å¯¹æ¯”

| åè®® | è¿æ¥ç±»å‹ | è¯»å–æ–¹å¼ | å†™å…¥æ–¹å¼ | ç¼–è§£ç  | è¾“å‡ºæ§åˆ¶ |
|------|---------|---------|---------|--------|---------|
| **Xiaozhi** | WebSocket | `ws.receive()` | `ws.send()` | Opus | FlowController (60ms) |
| **LiveKit** | WebRTC | `audio_stream.next()` | `audio_source.capture()` | å†…ç½® | PlayoutTracker |
| **Twilio** | WebSocket | `ws.receive()` | `ws.send()` | Î¼-law | FlowController |
| **UDP** | UDP Socket | `socket.recvfrom()` | `socket.sendto()` | è‡ªå®šä¹‰ | æ—  |

### 6.2 æŠ½è±¡éªŒè¯

æ‰€æœ‰åè®®éƒ½èƒ½æ˜ å°„åˆ°ç»Ÿä¸€æ¥å£ï¼š

| æ¡†æ¶æ¥å£ | Xiaozhi | LiveKit | UDP |
|---------|---------|---------|-----|
| `_do_read()` | âœ… | âœ… | âœ… |
| `_do_write()` | âœ… | âœ… | âœ… |
| `_create_audio_codec()` | Opus | None | è‡ªå®šä¹‰ |
| `_create_output_controller()` | FlowController | PlayoutTracker | None |

---

## 7. è¿ç§»ç­–ç•¥

### 7.1 æ¸è¿›å¼è¿ç§»ï¼ˆ4 é˜¶æ®µï¼‰

**Phase 1: å¼•å…¥ SessionTransportBase**
- åˆ›å»º `SessionTransportBase` æ¡†æ¶åŸºç±»
- å®šä¹‰æŠ½è±¡æ¥å£å’Œå…¬å…±èƒ½åŠ›
- ç°æœ‰ `TransportBase` æš‚ä¸ä¿®æ”¹

**Phase 2: å®ç° XiaozhiSessionTransport**
- åˆ›å»º `XiaozhiSessionTransport` ç»§æ‰¿æ¡†æ¶åŸºç±»
- è¿ç§» `XiaozhiTransport` ä¸­çš„ä¼šè¯ç›¸å…³é€»è¾‘
- éªŒè¯åŠŸèƒ½æ­£ç¡®

**Phase 3: åˆ†ç¦» TransportServer**
- åˆ›å»º `TransportServerBase` æŠ½è±¡åŸºç±»
- åˆ›å»º `XiaozhiTransportServer` å¤„ç†æœåŠ¡å™¨é€»è¾‘
- æ›´æ–° `SessionManager` é€‚é…æ–°æ¥å£

**Phase 4: æ¸…ç†å’Œæ–‡æ¡£**
- ç§»é™¤æ—§çš„ `TransportBase` ä»£ç 
- æ›´æ–° Station æ¥å£
- æ›´æ–°å¼€å‘è€…æ–‡æ¡£

### 7.2 å…¼å®¹æ€§ä¿è¯

è¿ç§»æœŸé—´ä¿æŒå‘åå…¼å®¹ï¼š
- `session.session_id` å§‹ç»ˆå¯è®¿é—®ï¼ˆç”¨äºæ—¥å¿—ï¼‰
- æä¾›é€‚é…å±‚åŒ…è£…æ—§æ¥å£
- é€æ­¥åºŸå¼ƒï¼Œç»™ç¬¬ä¸‰æ–¹è¿ç§»æ—¶é—´

---

## 8. ä¸ç°æœ‰è®¾è®¡çš„å…³ç³»

### 8.1 ä¸ SessionContext çš„å…³ç³»

ç°æœ‰çš„ `SessionContext`ï¼ˆè§ session-lifecycle-refactoring.mdï¼‰ä¸“æ³¨äº**èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†**ã€‚

æœ¬è®¾è®¡çš„ `SessionTransportBase` æ›´è¿›ä¸€æ­¥ï¼š
- ä¸ä»…ç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸ
- è¿˜æä¾›**å®Œæ•´çš„ä¼šè¯çº§ä¼ è¾“æ¥å£**
- ä½¿å†…éƒ¨ç»„ä»¶**å®Œå…¨ä¸æ„ŸçŸ¥ session_id**
- å®šä¹‰æ¸…æ™°çš„**ç¬¬ä¸‰æ–¹æ‰©å±•è¾¹ç•Œ**

ä¸¤è€…å¯ä»¥èåˆï¼š`SessionTransportBase` ç»§æ‰¿ `SessionContext` çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†èƒ½åŠ›ã€‚

### 8.2 ä¸ transport_architecture.md çš„å…³ç³»

ç°æœ‰çš„ transport_architecture.md å®šä¹‰äº†ï¼š
- TransportBase çš„æŠ½è±¡æ¥å£
- Protocol å±‚çš„èŒè´£
- è¾“å‡ºæ§åˆ¶ç­–ç•¥ï¼ˆFlowController / PlayoutTrackerï¼‰

æœ¬è®¾è®¡åœ¨å…¶åŸºç¡€ä¸Šï¼š
- å°† TransportBase æ‹†åˆ†ä¸º Server + Session ä¸¤å±‚
- **ä¿æŒ Protocol å±‚è®¾è®¡ä¸å˜**
- **ä¿æŒè¾“å‡ºæ§åˆ¶ç­–ç•¥ä¸å˜**
- è¾“å‡ºæ§åˆ¶å™¨ç§»å…¥ SessionTransportï¼ˆç”Ÿå‘½å‘¨æœŸæ›´æ¸…æ™°ï¼‰

---

## 9. é¢„æœŸæ”¶ç›Š

### 9.1 ä»£ç ç®€åŒ–

| æŒ‡æ ‡ | Before | After |
|------|--------|-------|
| Transport ä¸­çš„å­—å…¸æ•°é‡ | 10+ | 0 |
| SessionManager ä¸­çš„å­—å…¸æ•°é‡ | 5+ | 0 |
| éœ€è¦ä¼ é€’ session_id çš„æ–¹æ³• | 50+ | ä»…æ—¥å¿—ç›¸å…³ |
| èµ„æºæ¸…ç†ä»£ç è¡Œæ•° | 100+ | ~30 |

### 9.2 å¯ç»´æŠ¤æ€§æå‡

- **å•ç‚¹æ¸…ç†**ï¼šé”€æ¯ SessionTransport å³å¯é‡Šæ”¾æ‰€æœ‰èµ„æº
- **æ— é—æ¼é£é™©**ï¼šæ–°å¢èµ„æºåªéœ€æ·»åŠ åˆ° SessionTransport
- **æ˜“äºæµ‹è¯•**ï¼šå¯ä»¥ç‹¬ç«‹æ„é€  SessionTransport è¿›è¡Œå•å…ƒæµ‹è¯•
- **IDE æ”¯æŒ**ï¼šç›´æ¥å¼•ç”¨æ¯”å­—å…¸æŸ¥æ‰¾æœ‰æ›´å¥½çš„ç±»å‹æç¤º

### 9.3 æ‰©å±•æ€§æå‡

- **æ¸…æ™°çš„æ‰©å±•è¾¹ç•Œ**ï¼šç¬¬ä¸‰æ–¹åªéœ€å®ç° 3 ä¸ªå¿…é¡»æ–¹æ³•
- **åè®®æ— å…³**ï¼šæ¡†æ¶ä¸å‡è®¾åº•å±‚æ˜¯ WebSocket/RTC/UDP
- **ç­–ç•¥å¯é€‰**ï¼šè¾“å‡ºæ§åˆ¶ã€éŸ³é¢‘ç¼–è§£ç éƒ½æ˜¯å¯é€‰æ‰©å±•ç‚¹

---

## 10. é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| é‡æ„èŒƒå›´å¤§ | å¯èƒ½å¼•å…¥ bug | åˆ†é˜¶æ®µå®æ–½ï¼Œæ¯é˜¶æ®µå……åˆ†æµ‹è¯• |
| æ¥å£å˜åŒ–å¤š | ä¸‹æ¸¸ä»£ç éœ€ä¿®æ”¹ | ä¿æŒå…¼å®¹æ€§åŒ…è£…ï¼Œé€æ­¥è¿ç§» |
| å¤šåè®®éªŒè¯ | ä¸åŒåè®®å¯èƒ½æœ‰ä¸åŒéœ€æ±‚ | å…ˆå®Œæˆ Xiaozhiï¼Œè®¾è®¡æ—¶è€ƒè™‘ LiveKit åœºæ™¯ |

---

## 11. ä¸‹ä¸€æ­¥

1. [ ] è¯„å®¡æœ¬è®¾è®¡æ–‡æ¡£
2. [ ] åˆ›å»º `SessionTransportBase` æ¡†æ¶åŸºç±»
3. [ ] åˆ›å»º `TransportServerBase` æŠ½è±¡åŸºç±»
4. [ ] å®ç° `XiaozhiSessionTransport` ä½œä¸ºå‚è€ƒå®ç°
5. [ ] å®ç° `XiaozhiTransportServer`
6. [ ] æ›´æ–° `SessionManager`
7. [ ] æ›´æ–° Station æ¥å£
8. [ ] éªŒè¯åŠŸèƒ½å’Œæ€§èƒ½
9. [ ] æ›´æ–°ç¬¬ä¸‰æ–¹å¼€å‘æ–‡æ¡£
